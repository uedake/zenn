---
title: "Gaussian splatting論文読解１：基礎論文"
emoji: "📘"
type: "tech"
topics:
  - "gaussian splatting"
  - "novel view synthesis"
published: false
published_at: "2023-09-03 22:13"
---

# 解説対象

本記事では、カメラ画像を用いた3D復元等の技術のトレンドとなったGaussain splattingの元論文とソースコードをセットで解説します。

## 目標
本記事の目標は、自分でGaussain splattingの派生手法を開発できる程度に理論と実装を理解することです。

## 対象論文
- [3D Gaussian Splatting for Real-Time Radiance Field Rendering](https://arxiv.org/pdf/2308.04079)

## 対象コード
- [github:graphdeco-inria/gaussian-splatting](https://github.com/graphdeco-inria/gaussian-splatting)
- [github:graphdeco-inria/diff-gaussian-rasterization](https://github.com/graphdeco-inria/diff-gaussian-rasterization)

# 概要

## 何に関する技術？

カメラ画像から静的なシーンの輝度場（radiance field）を推定復元する技術。輝度場$L$（radiance field）とは、空間上のあらゆる点毎について、その点から出るあらゆる方向毎の輝度値を求められる関数のこと。輝度は密度（透明度に相当）とカラーの計4次元実ベクトル$R^{4+}$で考える

- $L(x, y, z, θ, ϕ) : \R^5→ \R^{4+}$
  - $x, y, z$ : 空間上の点の位置座標
  - $θ, ϕ$ : 空間上の点から出る光線の方向の球面座標

## 用途は？

シーンの輝度場（radiance field）を推定復元できれば、
- 自由視点画像合成（novel view synthesis）
  - シーンを任意の方向から見た画像を自由に生成できる

に使えるのが直接の効果だが、この技術が重要のは応用範囲が広いこと。例えば、
- visual-SLAMへの応用
  - カメラ映像から（カメラ位置を推定しながら）シーンの3次元地図を生成するvisual-SLAMにおいて特徴点マッチングによる疎な点群復元だけでなく、輝度場によって密な復元が高精度でできるようになる。

## 既存技術と比べて何がすごい？

- レンダリングの品質と速度を両立し、かつ学習にかかる時間も短縮したのがすごい
  - 2020年以降自由視点画像合成はNeRFとその派生手法がトレンドだったが、レンダリング品質をあげるとリアルタイム描画が不可能なほどレンダリング時間が大きくなり、品質と速度の両立が困難だった。
  - Gaussian Splattingは、既存手法の中で最高品質の手法と同等以上の品質でリアルタイム描画（30fps以上）を超える速度で描画できる。また、学習時間も短い（1時間以内）。

|手法|描画速度|学習時間|PSNR|
|--|--|--|--|
|Gaussian Splatting|93fps|51min|25.2|
|InstantNGP|9.2fps|7min|22.1|
|Mip-NeRF360|0.071fps|48h|24.3|
|（短時間学習）<br/>Gaussian Splatting|135fps|6min|23.6|

- 描画測度
  - 既存手法の中で高速なInstantNGPと比べて10倍速い
- 描画品質
  - 既存手法の中で高品質なMip-NeRF360と比べても若干品質が高い

## どうやってレンダリング速度と品質を両立？

以下がポイント

- 輝度場を「正規分布形状の大きさを持った点(=3D Gaussians)の**可変個**の集合」として表現した
- 3D Gaussiansの位置や色を学習で調整するのに加え、3D Gaussiansの数を学習時に動的に調整する仕組みを導入した
- 3D Gaussiansの集合から2D画像を高速にレンダリングするアルゴリズムを考案した

# 用語解説

## 輝度場の表現方法

シーンの輝度場をどのようなデータで表現するかの方法は大きく分けて2種類ある
1. implicitな（=3次元構造を明示しない）パラメータ表現
2. explicitな（=3次元構造上で離散的に定義する）パラメータ表現

オリジナルのNeRFは1。NeRF改良手法のうちレンダリング品質を高めたものはMip-NeRF360など1が多く、測度を高めたものはinstantNGPなど2が多い傾向。2は空間上で離散的にパラメータを定義する為に描画速度・学習速度が速い代わりに「隙間（パラメータが直接定義されていない位置）」を工夫して埋める必要があり、レンダリング品質のボトルネックになっていた。Gaussain splattingは2に属するが、隙間を正規分布（ガウス分布）で埋めるレンダリング手法を採用することで描画品質も向上させている。

### implicitなパラメータ表現の輝度場
- 表現方法
    - 3次元構造に紐づけないパラメータを用いる方法
    - 下記のようにパラメータ$W_{global}$で決まる関数$f_{implicit}$を考え、パラメータ$W_{global}$をシーンの輝度場の表現とする。シーンのある位置にパラメータ中のどの値が影響を与えるのかはブラックボックスになる。
    - $L(x, y, z, θ, ϕ) = f_{implicit}(x, y, z, θ, ϕ; W_{global})$
- 学習方法
    - 例えば、深層学習モデルとしてMLPを用いて関数を構成し重み$W_{global}$を学習によって最適化する
    - $f_{implicit}(x, y, z, θ, ϕ; W_{global})=MLP(x, y, z, θ, ϕ; W_{global})$
- メリット
    - パラメータ$W_{global}$のみでシーンを表現するので実装がシンプルであり、また総パラメータ数は比較的小さくデータ量をコンパクトにできる
- デメリット
    - 一方で、シーンの複雑さに対して$W_{global}$のサイズが不足してくると描画品質が落ちる。シーンに対して$W_{global}$のサイズがどの程度であるべきかは事前にはわからず試行錯誤する必要があるのは扱いづらい
    - また、シーン中の一部分を削除したり複製したりといった編集ができないので扱いづらい。

### explicitなパラメータ表現の輝度場
- 表現方法
    - 「3次元構造上で離散的に定義するパラメータ」の集合を総パラメータとして用いる方法
    - 下記のように位置に依存したパラメータ$P(x, y, z)$で決まる関数$f_{explicit}$と、パラメータ$W_{local}=\{W_{i}\}$で決まる関数$f_{smooth}$を考え、パラメータ$W_{i}|_{0<=i<=N-1}$をシーンの輝度場の表現とする。
    - $L(x, y, z, θ, ϕ) = f_{explicit}(θ, ϕ; P(x, y, z))$
    - $P(x, y, z) = f_{smooth}(x, y, z; W_{local})$
    - パラメータ$W_{i}|_{0<=i<=N-1}$は3次元空間上の位置毎に定義した$N$個のパラメータであり$N$点の移動可能な点群としたり、$N$点の固定ボクセル格子点としたりする。関数$f_{smooth}$は、空間的に離散的なパラメータ$W_{i}$を補完して連続的な位置$(x,y,z)$での$f_{explicit}$のパラメータを得るための関数である。
- メリット
    - $f_{explicit}$はパラメータが局所化されている為にある場所の輝度場を計算する為のパラメータ数は少なく計算速度は速くできる。またパラメータが3次元空間上で定義されているのでシーンの大きさや複雑さに応じてパラメータ$W_{i}$の数$N$を決めるのが容易である。
    - シーン中の一部分を削除したり複製したりといった編集が用意であり扱いやすい。
- デメリット
    - 一方で、総パラメータ数は大きいので複雑なシーンではパラメータを表すデータ量は大きくなる。

# 論文解説

## 数式の意味

### 3D gaussainの定義
論文中式(4)が3D gaussainの定義として書かれている

$$ G(\bm{x})=𝑒^{-\frac{1}{2}\bm{x}^TΣ^{-1}\bm{x}}$$

この式は、
- 中心位置が$\bm{μ} \in \R^3$
- 広がりを表す共分散行列が$Σ \in M_{3,3}(\R)$

である3D gaussainが世界座標系上の位置$\bm{x}=(x,y,z) \in \R^3$に与える影響の強さ（3D gaussainの濃さ）を表している。式の中に$\bm{μ}$が入ってないじゃないかと疑問が沸くが省略してかかれているだけで、正確な式は

$$ G(\bm{x})=𝑒^{-\frac{1}{2}(\bm{x}-\bm{μ})^TΣ^{-1}(\bm{x}-\bm{μ})}$$

である。

さらに言えば、ある位置$\bm{x}$に影響を与える3D gaussainは多数ありそれらを$i \in \N$で添え字づけすると、$i$番目の3D gaussain（位置$μ_i$・共分散$Σ_i$）が位置$\bm{x}$に与える影響の強さ$G_i(\bm{x})$は

$$ G_{i}(\bm{x})=𝑒^{-\frac{1}{2}(\bm{x}-\bm{μ_i})^TΣ_i^{-1}(\bm{x}-\bm{μ_i})}$$

と定義している。この式の形は多次元正規分布（多次元ガウス分布）であり、このように定義してあげることで3D gaussainの2次元画像への描画が高速に行えることが論文で記載されている。また、多次元正規分布（多次元ガウス分布）を用いている為にこの表現が「3D gaussain」と名付けられている。

### 3D gaussainの2次元画像上での見え方
論文中式(5)が3D gaussainの2次元画像上での見え方を表す式として書かれている

$$ Σ' = JWΣW^TJ^T $$

この式も、複数ある3D gaussainを添え字$i$で区別して記載すると、

$$ Σ'_i = JWΣ_iW^TJ^T $$

となる。（$J$と$W$は$i$とは無関係に決まる）

この式は、3D gaussainと2D gaussainの間に成り立つ関係を示している。3次元正規分布の広がりをもつ3D gaussain（位置$μ_i$・共分散$Σ_i$）はカメラ座標系で見ると（ある近似の下で）2次元正規分布の広がりをもつ2D gaussain（位置$μ_i^{C}$・共分散$Σ_i^{C}$）として見え$Σ_i$と$Σ_i^{C}$として見えることを示している。

$$ Σ_i^{C} = \begin{bmatrix} 1 & 0 & 0 \\ 0 & 1 & 0  \end{bmatrix} Σ'_i \begin{bmatrix} 1 & 0  \\ 0 & 1  \\ 0  & 0 \end{bmatrix} = \begin{bmatrix} 1 & 0 & 0 \\ 0 & 1 & 0  \end{bmatrix} JWΣ_iW^TJ^T \begin{bmatrix} 1 & 0  \\ 0 & 1  \\ 0  & 0 \end{bmatrix}$$

でつながる（$Σ'_i$の3行目と3列目を削除したことに等しい）

ここで用いられている近似は、3次元正規分布を射影変換（カメラ面に投影）しても厳密には2次元正規分布にならないが、ほぼ同じとみなせるという近似である。一般にn次元正規分布はアフィン変換してもn次元正規分布のままであり、射影変換はアフィン変換で近似できるという関係を用いている。

